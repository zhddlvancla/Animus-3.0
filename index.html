<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8"/>
<meta content="width=1280" name="viewport"/>
    <title>문명의 발생(Animus)</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;400;500;600;700&family=Share+Tech+Mono&family=Noto+Sans+KR:wght@100;300;400;500;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "animus-dark": "#0a0a12",
                        "animus-panel": "#13131f",
                        "animus-void": "#050508",
                        "animus-white": "#ffffff",
                        "animus-white-glow": "rgba(255, 255, 255, 0.8)",
                        "animus-dim": "rgba(255, 255, 255, 0.4)",
                        "animus-text-light": "#e0e6ed",
                        "animus-text-dim": "#8a9bb0",
                        "animus-accent": "#2a2a35",
                        "animus-ai": "rgb(var(--theme-rgb) / <alpha-value>)", /* 테마 변수 적용 */
                    },
                    fontFamily: {
                        tech: ["Rajdhani", "sans-serif"],
                        mono: ["Share Tech Mono", "monospace"],
                        kr: ["Noto Sans KR", "sans-serif"],
                    },
                    backgroundImage: {
                        'void-pattern': "radial-gradient(circle at 50% 50%, #1a1a24 0%, #0a0a12 100%)",
                        'data-grid': "linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px)",
                    },
                    boxShadow: {
                        'neon-glow': '0 0 10px rgba(255, 255, 255, 0.5), 0 0 20px rgba(255, 255, 255, 0.2)',
                        'panel-glow': 'inset 0 0 20px rgba(255, 255, 255, 0.05)',
                        'shard-shadow': '0 10px 30px -10px rgba(0, 0, 0, 0.8)',
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'scan': 'scan 3s linear infinite',
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                },
            },
        }
    </script>
    <style>
        /* 동기화 불안정/안정 상태 테마 컬러 제어 */
        :root {
            --theme-rgb: 153 27 27; /* 기본 불안정 상태: 어두운 붉은색 (Tailwind red-800) */
        }
        body.sync-stable {
            --theme-rgb: 74 222 128; /* 동기화 완료 상태: 기존 초록색 (Tailwind green-400) */
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        body { background-color: #0a0a12; color: #e0e6ed; transition: --theme-rgb 0.5s ease; }
        .glass-panel { background: rgba(19, 19, 31, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .shard { clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px); }
        .text-glow { text-shadow: 0 0 8px rgba(255, 255, 255, 0.7); }
        .google-map-container { filter: grayscale(0.6) sepia(0.4) hue-rotate(170deg) brightness(0.85) contrast(1.1); opacity: 0.8; transition: all 0.5s ease; }
        .google-map-container:hover { opacity: 1; filter: grayscale(0.2) sepia(0.2) hue-rotate(170deg) brightness(1) contrast(1.1); }
        
        .source-box { border: 1px dashed rgba(255,255,255,0.3); padding: 1.5rem; background: rgba(255,255,255,0.03); border-radius: 4px; }
        #detail-image { background-size: cover; background-position: center; }
        .section-title { font-size: 1.3rem; font-weight: 700; color: rgb(var(--theme-rgb)); margin-bottom: 1rem; border-bottom: 2px solid rgb(var(--theme-rgb) / 0.3); display: inline-block; padding-bottom: 4px; }
        
        #view-timeline { overflow-x: auto; scroll-behavior: smooth; }
        .timeline-node { width: 20px; height: 20px; border-radius: 50%; background: #0a0a12; border: 4px solid rgb(var(--theme-rgb)); box-shadow: 0 0 15px rgb(var(--theme-rgb) / 0.6); position: relative; z-index: 30; flex-shrink: 0; transition: all 0.3s ease; }
        
        /* 순수 크로스페이드 트랜지션 애니메이션 */
        #transition-overlay {
            background-color: #050508;
            opacity: 0;
            transition: opacity 0.6s ease-in-out;
        }
        #transition-overlay.show {
            opacity: 1;
        }

        /* 대문 배경 블랙룸(격자) 및 글리치 효과 복구 */
        .screen-glitch::before {
            content: "";
            position: absolute;
            inset: 0;
            background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(255, 255, 255, 0.03) 2px, rgba(255, 255, 255, 0.03) 4px);
            z-index: 101;
            pointer-events: none;
            opacity: 0;
            animation: flash-glitch 5s infinite;
        }
        @keyframes flash-glitch {
            0%, 9%, 11%, 100% { opacity: 0; clip-path: inset(0 0 0 0); }
            10% { opacity: 0.8; clip-path: inset(10% 0 80% 0); transform: translateX(-1px); }
        }

        .glitch-flicker { animation: opacity-flicker 3s infinite; }
        @keyframes opacity-flicker {
            0%, 4%, 6%, 19%, 21%, 79%, 81%, 100% { opacity: 1; transform: translateX(0); }
            5%, 20%, 80% { opacity: 0.8; transform: translateX(1px); }
        }
        .glitch-shift { position: relative; animation: rgb-shift 0.3s infinite alternate; }
        @keyframes rgb-shift {
            0% { text-shadow: 1px 0 0 rgba(255, 0, 0, 0.4), -1px 0 0 rgba(0, 255, 255, 0.4); }
            100% { text-shadow: -1px 0 0 rgba(255, 0, 0, 0.4), 1px 0 0 rgba(0, 255, 255, 0.4); }
        }
        .subtle-glitch { animation: subtle-rgb-shift 3s infinite alternate; }
        @keyframes subtle-rgb-shift {
            0%, 90% { text-shadow: none; opacity: 0.7; transform: translateX(0); }
            92% { text-shadow: 1px 0 0 rgba(255,0,0,0.6), -1px 0 0 rgba(0,255,255,0.6); opacity: 1; transform: translateX(0.5px); }
            94% { text-shadow: none; opacity: 0.7; transform: translateX(0); }
            96% { text-shadow: -1px 0 0 rgba(255,0,0,0.6), 1px 0 0 rgba(0,255,255,0.6); opacity: 1; transform: translateX(-0.5px); }
            98%, 100% { text-shadow: none; opacity: 0.7; transform: translateX(0); }
        }
        .black-room-bg {
            position: absolute; inset: 0;
            background: radial-gradient(circle at 50% 50%, #2a2a32 0%, #111118 100%);
            z-index: 1;
        }
        .black-room-ceiling {
            position: absolute; top: 0; left: -50%; width: 200%; height: 50%;
            background-image: linear-gradient(90deg, rgba(0, 0, 0, 0.6) 1.5px, transparent 1.5px), linear-gradient(0deg, rgba(0, 0, 0, 0.6) 1.5px, transparent 1.5px);
            background-size: 80px 80px;
            transform: perspective(600px) rotateX(-75deg); transform-origin: bottom center;
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 90%);
            mask-image: linear-gradient(to bottom, transparent 0%, black 90%);
            animation: forward-grid 3s linear infinite; z-index: 2;
        }
        .black-room-floor {
            position: absolute; bottom: 0; left: -50%; width: 200%; height: 50%;
            background-image: linear-gradient(90deg, rgba(0, 0, 0, 0.6) 1.5px, transparent 1.5px), linear-gradient(0deg, rgba(0, 0, 0, 0.6) 1.5px, transparent 1.5px);
            background-size: 80px 80px;
            transform: perspective(600px) rotateX(75deg); transform-origin: top center;
            -webkit-mask-image: linear-gradient(to top, transparent 0%, black 90%);
            mask-image: linear-gradient(to top, transparent 0%, black 90%);
            animation: forward-grid 3s linear infinite; z-index: 2;
        }
        @keyframes forward-grid {
            0% { background-position: 0px 0px, 0px 0px; }
            100% { background-position: 0px 0px, 0px 80px; }
        }
        
        .map-marker {
            position: absolute;
            width: 16px;
            height: 16px;
            background-color: rgb(var(--theme-rgb));
            border-radius: 50%;
            box-shadow: 0 0 10px rgb(var(--theme-rgb)), 0 0 20px rgb(var(--theme-rgb));
            transform: translate(-50%, -50%);
            animation: pulse-marker 2s infinite;
        }
        @keyframes pulse-marker {
            0% { box-shadow: 0 0 0 0 rgb(var(--theme-rgb) / 0.7); }
            70% { box-shadow: 0 0 0 15px rgb(var(--theme-rgb) / 0); }
            100% { box-shadow: 0 0 0 0 rgb(var(--theme-rgb) / 0); }
        }
    </style>
</head>
<body class="bg-animus-void text-animus-text-light font-kr overflow-hidden h-screen flex flex-col relative">
<audio id="bgm-player" src="ANIMUS BGM.mp3" loop></audio>

<!-- 순수 크로스페이드 트랜지션 오버레이 -->
<div id="transition-overlay" class="fixed inset-0 z-[150] pointer-events-none hidden"></div>

<div id="intro-screen" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-[#1e1e24] transition-all duration-[1500ms] ease-in-out origin-center cursor-pointer screen-glitch" onclick="initAudioContext()">
    <div class="black-room-bg pointer-events-none"></div>
    <div class="black-room-ceiling pointer-events-none"></div>
    <div class="black-room-floor pointer-events-none"></div>
    <div id="intro-content" class="relative z-10 flex flex-col items-center text-center max-w-2xl px-6 pointer-events-none glitch-flicker">
        <div class="size-24 bg-black/60 border border-white/20 flex items-center justify-center relative shadow-neon-glow mb-10 animate-float rounded-sm">
            <svg viewBox="0 0 100 100" class="w-14 h-14 fill-white drop-shadow-[0_0_10px_rgba(255,255,255,0.8)] glitch-shift">
                <path d="M50 15 L10 85 L35 85 L50 55 L65 85 L90 85 Z" />
            </svg>
            <div class="absolute top-0 left-0 w-4 h-4 border-t-2 border-l-2 border-white"></div>
            <div class="absolute bottom-0 right-0 w-4 h-4 border-b-2 border-r-2 border-white"></div>
        </div>
        <h1 class="text-7xl font-bold tracking-[0.3em] uppercase font-tech text-white mb-2 glitch-shift">Animus <span class="text-4xl opacity-50">3.0</span></h1>
        <p id="system-status" class="text-white font-mono tracking-[0.4em] text-sm mb-16 font-bold glitch-shift text-red-500 drop-shadow-[0_0_8px_rgba(255,0,0,0.8)]">SYSTEM UNSTABLE // UNSYNCHRONIZED</p>
        <p id="click-to-start-text" class="text-white/50 text-xs font-tech tracking-widest uppercase mb-4 animate-pulse">화면을 클릭하여 신경망을 연결할 것</p>
        <button id="btn-init-sync" onclick="event.stopPropagation(); startSyncSequence();" class="hidden relative group px-14 py-5 glass-panel border border-white/50 hover:border-white transition-all shadow-[0_0_15px_rgba(255,255,255,0.2)] hover:shadow-neon-glow overflow-hidden cursor-pointer rounded-sm pointer-events-auto">
            <div class="absolute inset-0 w-0 bg-white/20 transition-all duration-700 ease-out group-hover:w-full"></div>
            <span class="relative flex items-center gap-4 text-white font-tech tracking-[0.2em] font-bold text-xl uppercase">
                <span class="material-symbols-outlined text-white group-hover:animate-spin drop-shadow-[0_0_5px_rgba(255,255,255,0.8)]">settings_input_component</span>
                동기화 시작 [ INITIATE SYNC ]
            </span>
        </button>
        <div id="sync-progress-container" class="hidden w-full max-w-md mt-4 pointer-events-auto">
            <div class="flex justify-between text-[11px] text-white font-mono mb-2 uppercase tracking-widest font-bold drop-shadow-[0_0_5px_rgba(255,255,255,0.5)]">
                <span id="sync-status-text">STABILIZING NEURAL LINK...</span>
                <span id="sync-percentage">0%</span>
            </div>
            <div class="w-full h-1.5 bg-white/20 rounded overflow-hidden relative shadow-inner">
                <div id="sync-progress-bar" class="absolute top-0 left-0 h-full bg-white w-0 shadow-[0_0_10px_#ffffff] transition-all duration-[200ms] ease-linear"></div>
            </div>
        </div>
    </div>
</div>

<div class="absolute inset-0 z-0 bg-void-pattern pointer-events-none"></div>

<header class="flex items-center justify-between glass-panel z-40 relative h-16 border-b border-white/20 px-6 flex-shrink-0">
    <div class="flex items-center gap-4 group cursor-pointer" onclick="switchMainTab('database')">
        <div class="size-10 text-white border border-white/40 flex items-center justify-center relative bg-black/40 shadow-neon-glow">
            <svg viewBox="0 0 100 100" class="w-6 h-6 fill-white drop-shadow-[0_0_5px_rgba(255,255,255,0.8)]">
                <path d="M50 15 L10 85 L35 85 L50 55 L65 85 L90 85 Z" />
            </svg>
            <div class="absolute top-0 left-0 w-2 h-2 border-t border-l border-white"></div>
            <div class="absolute bottom-0 right-0 w-2 h-2 border-b border-r border-white"></div>
        </div>
        <div class="flex flex-col">
            <div class="flex items-center gap-3">
                <h2 class="text-white text-2xl font-bold tracking-[0.2em] uppercase font-tech text-glow">Animus <span class="text-white text-base align-top opacity-80">3.0</span></h2>
                <div id="sync-status-badge" class="hidden sm:flex items-center gap-1 bg-animus-ai/10 border border-animus-ai/30 px-2 py-0.5 rounded-sm subtle-glitch">
                    <span id="sync-status-icon" class="material-symbols-outlined text-[10px] text-animus-ai">warning</span>
                    <span id="sync-status-label" class="text-[9px] text-animus-ai font-mono tracking-widest font-bold uppercase mt-0.5">Sync: Unstable</span>
                </div>
            </div>
            <span class="text-[10px] text-animus-text-dim tracking-widest font-mono uppercase mt-0.5">Ancient History // Neural Sync Mode</span>
        </div>
    </div>
    <nav class="hidden md:flex items-center gap-8 h-full">
        <a id="nav-database" onclick="switchMainTab('database')" class="text-animus-text-dim hover:text-white transition-all text-sm font-semibold uppercase font-tech px-2 cursor-pointer h-full flex items-center border-b-2 border-transparent hover:border-white/50 duration-300">데이터베이스</a>
        <a id="nav-sync" onclick="switchMainTab('sync')" class="text-animus-text-dim hover:text-white transition-all text-sm font-semibold uppercase font-tech px-2 cursor-pointer h-full flex items-center border-b-2 border-transparent hover:border-white/50 duration-300">동기화</a>
        <a id="nav-timeline" onclick="switchMainTab('timeline')" class="text-animus-text-dim hover:text-white transition-all text-sm font-semibold uppercase font-tech px-2 cursor-pointer h-full flex items-center border-b-2 border-transparent hover:border-white/50 duration-300">연표</a>
    </nav>
    <div class="flex items-center gap-3">
        <button id="btn-complete-sync" onclick="completeSync()" class="flex items-center gap-2 text-animus-ai hover:text-white px-4 py-2 border border-animus-ai/30 hover:border-animus-ai hover:bg-animus-ai/20 transition-all duration-300 font-tech uppercase tracking-wider text-xs font-bold rounded-sm">
            <span class="material-symbols-outlined text-sm">task_alt</span>
            <span>동기화 완료 (Complete)</span>
        </button>
        <button onclick="playUIBeep(); location.reload()" class="flex items-center gap-2 text-white hover:text-black px-4 py-2 border border-white/30 hover:border-white hover:bg-white transition-all duration-300 font-tech uppercase tracking-wider text-xs font-bold rounded-sm">
            <span class="material-symbols-outlined text-sm">refresh</span>
            <span>Reboot</span>
        </button>
    </div>
</header>

<main class="flex-1 flex overflow-hidden relative">
    <div id="view-database" class="flex-1 flex w-full h-full">
        <aside class="w-72 glass-panel flex flex-col z-30 relative shadow-shard-shadow border-r border-white/20 flex-shrink-0">
            <div class="p-5 border-b border-white/10">
                <h1 class="text-[11px] font-bold opacity-80 text-animus-text-light mb-1 font-kr tracking-wide">II. 문명의 발생과 고대 세계의 형성<br/><span class="text-white font-bold font-kr text-lg tracking-widest text-glow mt-1 block">01. 선사 문화와 문명의 특징</span></h1>
            </div>
            <div id="civilization-list-container" class="flex-1 overflow-y-auto no-scrollbar p-4 space-y-3"></div>
            <div class="p-4 border-t border-white/10 bg-black/20">
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-black/40 border border-white/10 p-2 text-center">
                        <div class="text-[9px] text-animus-text-dim uppercase font-bold tracking-widest font-tech mb-1">Session</div>
                        <div id="timer" class="text-white font-mono text-sm font-bold tracking-wider text-glow">00:00:00</div>
                    </div>
                    <div class="bg-black/40 border border-white/10 p-2 text-center">
                        <div class="text-[9px] text-animus-text-dim uppercase font-bold tracking-widest font-tech mb-1">Integrity</div>
                        <div class="text-animus-ai font-mono text-sm font-bold tracking-wider">98.2%</div>
                    </div>
                </div>
            </div>
        </aside>

        <section class="flex-1 flex flex-col relative bg-[#050508] overflow-hidden">
            <div class="absolute top-0 left-0 right-0 z-20 p-4 flex justify-end items-start pointer-events-none">
                <div class="pointer-events-auto glass-panel px-4 py-2 flex items-center gap-4 shard">
                    <div class="flex items-center gap-3">
                        <div class="w-[2px] h-4 bg-white shadow-[0_0_8px_white]"></div>
                        <div id="breadcrumb" class="text-[10px] font-bold tracking-[0.15em] font-tech uppercase text-animus-text-light flex gap-2">
                            <span class="text-animus-text-dim">WORLD</span> / <span>ANCIENT</span> / <span class="text-white text-glow" id="active-region-name">MESOPOTAMIA</span>
                        </div>
                    </div>
                </div>
            </div>
            <div id="map-container" class="flex-1 relative w-full h-full bg-[#0a0a0f] flex items-center justify-center overflow-hidden">
                <div id="google-map-wrapper" class="absolute inset-0 w-full h-full google-map-container">
                    <iframe id="google-map-iframe" class="w-full h-full border-none" src="about:blank" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"></iframe>
                </div>
                <div id="origin-markers" class="absolute inset-0 z-20 hidden pointer-events-none"></div>
                <div class="absolute inset-0 pointer-events-none z-10 opacity-20 bg-data-grid bg-[length:60px_60px]"></div>
                <!-- 팝업 위치를 핀의 우측 옆으로 이동 -->
                <div id="civilization-popup" class="absolute glass-panel p-0 z-30 animate-float shard hidden w-72 left-[calc(50%+45px)] top-1/2 -translate-y-1/2">
                    <div class="p-4 bg-black/80 backdrop-blur-md">
                        <h3 id="popup-title" class="text-white font-bold text-lg mb-1 font-kr text-glow">문명 탐색</h3>
                        <p id="popup-desc" class="text-animus-text-light text-[11px] mb-2 font-kr opacity-90 border-l border-white/30 pl-2 break-keep leading-relaxed">데이터 로딩 중...</p>
                    </div>
                </div>
            </div>
        </section>

        <aside class="w-80 glass-panel border-l border-white/20 hidden md:flex flex-col z-30 shadow-[-10px_0_30px_rgba(0,0,0,0.5)] flex-shrink-0 p-5">
            <h3 class="text-xs font-bold text-white uppercase font-tech text-glow tracking-widest pb-4 border-b border-white/10 mb-4">Archival Details</h3>
            <div id="detail-content" class="flex-1 overflow-y-auto no-scrollbar flex flex-col justify-between">
                <div>
                    <div class="relative w-full aspect-[4/3] border border-white/30 bg-black/40 overflow-hidden shard">
                        <div id="detail-image" class="absolute inset-0 transition-transform duration-700"></div>
                        <div class="absolute inset-0 bg-gradient-to-t from-black via-black/40 to-transparent"></div>
                        <div class="absolute bottom-3 left-3"><h2 id="detail-title" class="text-white font-bold text-xl font-kr text-glow">데이터 단편</h2></div>
                    </div>
                    <div id="detail-sections" class="mt-4"></div>
                </div>
                <div class="mt-auto pt-8 flex justify-end">
                    <button id="btn-run-sync" onclick="switchMainTab('sync')" class="px-5 py-2 bg-animus-ai/10 text-animus-ai border border-animus-ai/40 font-bold uppercase tracking-widest hover:bg-animus-ai/20 transition-all shard cursor-pointer text-xs flex items-center gap-2">
                        <span class="material-symbols-outlined text-sm">sync</span> 동기화 실행
                    </button>
                </div>
            </div>
        </aside>
    </div>

    <div id="view-sync" style="display:none" class="flex-1 flex-col w-full h-full bg-[#050508] p-6 overflow-y-auto no-scrollbar relative">
        <div id="sync-tabs-container" class="flex gap-2 border-b border-white/20 mb-6 flex-wrap"></div>
        <div id="sync-dynamic-content" class="grid grid-cols-1 lg:grid-cols-3 gap-8"></div>
    </div>

    <div id="view-timeline" style="display:none" class="flex-1 w-full h-full bg-[#050508] overflow-x-auto no-scrollbar relative">
        <div id="timeline-wrapper" class="relative flex items-center h-full px-[10vw] min-w-max">
            <div class="absolute left-0 w-full top-1/2 h-[2px] z-10" style="background: rgb(var(--theme-rgb) / 0.8); box-shadow: 0 0 15px rgb(var(--theme-rgb) / 0.4); transform: translateY(-50%);"></div>
            <div id="timeline-events-container" class="flex flex-row items-center gap-[60px] relative z-20 h-full"></div>
        </div>
    </div>
</main>

<script>
    let audioCtx, audioInitialized = false, currentCivId = 'mesopotamia', currentSyncCivId = 'mesopotamia';

    const setSafeText = (id, t) => { const e = document.getElementById(id); if (e) e.innerText = t; };
    const setSafeHTML = (id, h) => { const e = document.getElementById(id); if (e) e.innerHTML = h; };

    const civImages = {
        origin: 'A.jpg',
        mesopotamia: 'B.jpg',
        egypt: 'C.jpg',
        india: 'D.jpg',
        china: 'E.jpg'
    };

    function initAudioContext() {
        if (audioInitialized) return;
        try {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        } catch(e) {}
        playUIBeep();
        document.getElementById('click-to-start-text').classList.add('hidden');
        document.getElementById('btn-init-sync').classList.remove('hidden');
        
        const bgm = document.getElementById('bgm-player');
        if (bgm) {
            bgm.volume = 0.4; // 0.1(작음) ~ 1.0(큼) 사이로 볼륨 조절 가능
            // 오디오 파일이 없을 때 발생하는 오류(NotSupportedError)를 무시하도록 예외 처리 추가
            bgm.play().catch(e => console.warn("오디오 재생 실패 (파일이 없거나 브라우저 정책 때문일 수 있습니다):", e));
        }
        audioInitialized = true;
    }

    function playUIBeep() {
        if (!audioCtx) return;
        try {
            const o = audioCtx.createOscillator(), g = audioCtx.createGain(), f = audioCtx.createBiquadFilter();
            o.type = 'triangle'; 
            o.frequency.setValueAtTime(120, audioCtx.currentTime); 
            o.frequency.exponentialRampToValueAtTime(30, audioCtx.currentTime + 0.15);
            f.type = 'lowpass'; 
            f.frequency.setValueAtTime(300, audioCtx.currentTime);
            g.gain.setValueAtTime(0, audioCtx.currentTime); 
            g.gain.linearRampToValueAtTime(0.4, audioCtx.currentTime + 0.02);
            g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.15);
            o.connect(f); f.connect(g); g.connect(audioCtx.destination);
            o.start(); o.stop(audioCtx.currentTime + 0.15);
        } catch(e) {}
    }

    function completeSync() {
        playUIBeep();
        document.body.classList.add('sync-stable');
        document.getElementById('sync-status-icon').innerText = 'check_circle';
        document.getElementById('sync-status-label').innerText = 'Sync: Stabilized';
        document.getElementById('sync-status-badge').classList.remove('subtle-glitch');
        document.getElementById('btn-complete-sync').style.display = 'none';
    }

    function playTransition(callback) {
        playUIBeep();
        const overlay = document.getElementById('transition-overlay');
        overlay.classList.remove('hidden');
        overlay.classList.add('flex');
        
        requestAnimationFrame(() => {
            requestAnimationFrame(() => {
                overlay.classList.add('show');
                setTimeout(() => {
                    if (callback) callback();
                    setTimeout(() => {
                        overlay.classList.remove('show');
                        setTimeout(() => {
                            overlay.classList.add('hidden');
                            overlay.classList.remove('flex');
                        }, 600); 
                    }, 200); 
                }, 600); 
            });
        });
    }

    function startSyncSequence() {
        playUIBeep();
        document.getElementById('btn-init-sync').classList.add('hidden');
        document.getElementById('sync-progress-container').classList.remove('hidden');
        let progress = 0;
        const interval = setInterval(() => {
            progress += 5;
            document.getElementById('sync-progress-bar').style.width = `${progress}%`;
            document.getElementById('sync-percentage').innerText = `${progress}%`;
            if (progress >= 100) {
                clearInterval(interval);
                playTransition(() => {
                    document.getElementById('intro-screen').classList.add('hidden');
                    const views = { database: 'view-database', sync: 'view-sync', timeline: 'view-timeline' };
                    Object.entries(views).forEach(([key, id]) => {
                        const el = document.getElementById(id);
                        if(el) { el.style.display = key === 'database' ? 'flex' : 'none'; el.classList.toggle('hidden', key !== 'database'); }
                    });
                    ['nav-database', 'nav-sync', 'nav-timeline'].forEach(n => {
                        const el = document.getElementById(n);
                        if (el) el.classList.remove('text-animus-ai', 'border-animus-ai');
                    });
                    document.getElementById('nav-database')?.classList.add('text-animus-ai', 'border-animus-ai');
                    renderCivilization('origin');
                });
            }
        }, 50);
    }

    const civilizations = [
        {
            id: 'origin', name: '문명의 발생', detailTitle: '인류 문명의 시작', engName: 'Origin of Civilization',
            coords: '30, 60', period: '기원전 3500년경~',
            summary: '큰 강 유역을 중심으로 농경과 목축이 발달하고 도시 국가가 형성되었다.',
            description: '기원전 3500년경부터 큰 강 유역에서 농사가 발달하며 잉여 생산물과 계급이 생겨났다. 이후 문자를 사용하고 도시 국가가 형성되며 문명으로 발전하였다.',
            coreData: [
                {
                    title: "큰 강 유역의 정착과 농경 발달",
                    content: "농사를 짓기 시작하면서 인류는 기름진 평야가 펼쳐진 큰 강 주변에 모여 살았다. 사람들은 홍수를 막고자 강가에 둑을 쌓고, 가뭄에 대비해 농지에 물을 대는 관개 시설을 만들었다."
                },
                {
                    title: "도시의 형성과 계급 발생",
                    content: "주변에서 구하기 힘든 자원은 물길을 따라 교역하며 얻었다. 이 과정에서 대규모 노동력이 필요해지며 여러 부족이 통합하여 도시가 생겨났다. 농업 생산량 증가로 잉여 생산물이 생기며 빈부의 차가 커졌고, 계급이 발생하였다."
                },
                {
                    title: "문명의 탄생과 4대 문명",
                    content: "청동 무기를 사용한 정복 활동이 활발해졌다. 일부 도시는 지배 계급이 군대와 정치 조직, 왕궁, 신전, 성곽을 세우며 도시 국가로 발전하였다. 또한 통치와 교역을 기록하기 위해 문자를 사용하면서 문명을 일구었다. 대표적으로 메소포타미아, 이집트, 인도, 중국 문명이 있다."
                }
            ],
            wiki: '문명의 발생은 인류가 채집과 수렵에서 벗어나 농경을 시작하며 이루어졌다. 잉여 생산물이 생기면서 빈부 격차와 계급이 발생했고, 사람들은 청동기 무기를 사용하여 주변 지역을 정복하고 도시 국가를 세웠다. 정치와 경제, 사회를 통제하기 위해 문자가 발명되었고 여러 형태의 종교가 나타났다.',
            textbookData: {
                sources: [
                    {
                        title: "사료 탐구: 우르의 기",
                        image: "F.jpg",
                        content: "메소포타미아의 도시 국가 우르에서 발견된 유물이다. 연회에 참석한 지배층과 일하는 평민, 포로로 잡힌 노예의 모습이 뚜렷하게 구분되어 있어 계급 사회의 성립을 알 수 있다. 또한 전차와 무기를 든 군인들의 모습을 통해 잦은 정복 전쟁이 벌어졌음을 보여준다."
                    },
                    {
                        title: "사료 탐구: 문명",
                        content: "선사 시대 이후 인류는 큰 강 유역에 정착하여 농경을 발전시켰다. 잉여 생산물을 둘러싸고 사유 재산과 계급이 발생하였으며, 강력한 지배자가 등장하여 도시 국가를 형성하였다. 이들은 청동기 무기로 주변을 정복하고, 조세 징수와 통치를 위해 문자를 발명하며 본격적인 문명의 시대로 나아갔다."
                    }
                ]
            }
        },
        {
            id: 'mesopotamia', name: '메소포타미아 문명', detailTitle: '지구라트', engName: 'Mesopotamia',
            coords: '31.038, 46.103', period: '3500 BC',
            summary: '개방적 지형으로 이민족의 침입이 잦아 현세적 종교관이 발달했다. 태음력, 60진법을 사용했다.',
            description: '개방적인 지형으로 이민족의 잦은 침입을 받았으며, 그 결과 사후 세계보다 현재의 삶을 중시하는 종교관을 가졌다.',
            coreData: [
                {
                    title: "개방적 지형과 도시 국가의 형성",
                    content: "서아시아 지역에서는 기원전 3500년경 수메르인이 여러 도시 국가를 세우면서 메소포타미아 문명이 일어났다. 티그리스강과 유프라테스강 주변의 개방적인 지형으로 주변과의 교류가 활발하였다. 잦은 전쟁과 이민족 침입으로 인해 사람들은 죽은 뒤의 세계보다 현재의 안정된 삶을 중시하였다."
                },
                {
                    title: "수메르인의 기술과 문화",
                    content: "수메르인들은 도시 중앙에 '지구라트'라는 거대한 신전을 세웠다. 달과 별의 움직임을 연구하여 점성술과 태음력을 발전시켰고, 이를 바탕으로 60진법을 만들었다. 또한 '쐐기 문자'를 이용하여 통치와 교역 내용 등을 점토판에 적었다."
                },
                {
                    title: "바빌로니아 왕국의 통일",
                    content: "수메르인의 도시 국가가 쇠퇴한 후 아무르인이 바빌로니아 왕국을 세웠다. 기원전 1800년경 함무라비왕이 메소포타미아 지방을 통일하고 함무라비 법전을 만들어 통치 체제를 정비하였다. 이후 바빌로니아는 기원전 1500년경 철제 무기를 지닌 히타이트인에게 멸망하였다."
                }
            ],
            wiki: '지구라트는 수메르어로 \'높은 곳\'을 의미하며, 하늘의 신이 지상으로 내려오는 계단이자 신과 인간을 연결하는 성스러운 통로다. 주로 우르 제3왕조 시기에 축조된 우르의 지구라트가 유명하며, 층마다 다른 색깔의 벽돌을 사용하여 우주적 질서를 상징했다. 단순한 신전 이상으로 도시의 경제적 중심지이자 기록의 보관소 역할도 수행했으며, 제사장들이 하늘의 별을 관측하던 천문대의 기능도 겸했다.',
            textbookData: {
                sources: [
                    {
                        title: "사료 탐구: 쐐기 문자",
                        image: "G.jpg",
                        content: "메소포타미아 사람들은 점토판에 갈대 줄기 끝으로 문자를 새겨 기록을 남겼는데, 그 모양이 쐐기(V자 모양)를 닮아 쐐기 문자라고 부른다. 이 문자로 왕의 업적, 법전, 일상생활의 기록 등을 남겼다."
                    },
                    {
                        title: "사료 탐구: 함무라비 법전",
                        customBlock: `
                            <div class="bg-black/40 p-4 mb-4 border border-white/20 text-white font-mono text-[13px] leading-relaxed break-keep">
                                200조 만약 귀족이 자기와 같은 신분인 사람의 이를 부러뜨렸다면 그의 이를 부러뜨릴 것이다.<br>
                                201조 만약 귀족이 평민의 이를 부러뜨렸다면 그는 은화 3분의 1미나를 줄 것이다.<br>
                                202조 만약 자기보다 높은 신분인 사람의 뺨을 때렸다면 그는 공개 된 자리에서 채찍 60대를 맞을 것이다.
                            </div>
                        `,
                        content: "이 법전은 '눈에는 눈, 이에는 이'라는 보복주의 원칙을 바탕으로 하고 있다. 하지만 신분과 계급에 따라 형벌이 다르게 적용되는 것을 통해 당시 메소포타미아 사회가 엄격한 계급 사회였음을 알 수 있다."
                    }
                ]
            }
        },
        {
            id: 'egypt', name: '이집트 문명', detailTitle: '피라미드', engName: 'Ancient Egypt',
            coords: '29.979, 31.134', period: '3000 BC',
            summary: '폐쇄적 지형 덕분에 오랫동안 통일 국가를 유지했으며, 내세적 종교관이 발달했다. 태양력과 10진법을 사용했다.',
            description: '나일강의 범람을 통해 농업이 발달했다. 폐쇄적 지형 덕분에 통일 왕국을 오래 유지했으며 내세적 종교관이 발달하였다.',
            coreData: [
                {
                    title: "나일강의 축복과 통일 왕국",
                    content: "이집트의 나일강은 주기적으로 범람하여 강 주변의 땅이 매우 기름졌다. 이곳에서는 일찍부터 농업이 발달하여 도시 국가가 세워졌고, 기원전 3000년경 여러 도시 국가를 통합한 통일 왕국이 성립되었다."
                },
                {
                    title: "신권 정치와 내세적 세계관",
                    content: "이집트의 왕 파라오는 살아 있는 신으로 여겨졌으며, 종교와 정치를 결합한 신권 정치로 절대 권력을 누렸다. 이집트인들은 사후에도 영혼이 남는다고 믿어 시신을 미라로 만들었고, 파라오의 미라를 보존하려 피라미드를 건설했으며 무덤에 「사자의 서」를 넣었다."
                },
                {
                    title: "과학 기술과 문자의 발달",
                    content: "나일강의 범람 시기를 알기 위해 태양력을 만들었다. 범람한 뒤의 농경지를 정비하는 과정에서 기하학과 측량술을 발달시켰고 10진법을 사용하였다. 또한 사물의 모양을 본뜬 상형 문자를 만들어 파피루스에 기록하였다."
                }
            ],
            wiki: '기자의 대피라미드는 파라오 쿠푸의 영생을 위해 축조된 인류 최대의 석조 건축물이다. 약 230만 개의 거대한 석재가 오차 없이 맞물려 있으며, 사면이 정확히 동서남북을 향하는 기하학적 정밀함을 자랑한다. 이는 파라오가 사후에도 신으로서 백성을 통치한다는 믿음과 이집트인들의 뛰어난 수학적, 기하학적 역량을 상징한다.',
            textbookData: {
                sources: [
                    {
                        title: "사료 탐구: 사자의 서",
                        image: "H.jpg",
                        content: "사후 세계에서 오시리스의 심판을 무사히 통과하기 위한 지침과 주문을 담은 안내서이다. 현세의 삶이 내세로 이어진다고 굳게 믿었던 이집트인들의 내세적 세계관이 담겨 있다."
                    },
                    {
                        title: "사료 탐구: 미라",
                        image: "I.jpg",
                        content: "이집트인들은 영혼 불멸과 사후 세계를 굳게 믿어, 죽은 사람의 영혼이 다시 돌아올 몸을 보존하기 위해 시신을 미라로 만들었다. 이러한 과정에서 의학과 해부학이 발달하기도 하였다."
                    }
                ]
            }
        },
        {
            id: 'india', name: '인도 문명', detailTitle: '모헨조다로 유적', engName: 'Indian Civilization',
            coords: '30.630, 72.866', period: '2500 BC',
            summary: '하라파와 모헨조다로 등 철저한 계획 도시가 발달했다. 이후 철기를 지닌 아리아인이 진출하여 카스트제와 브라만교를 성립시켰다.',
            description: '거대한 계획 도시를 지닌 인더스 문명이 발달했다. 이후 이동해 온 아리아인이 엄격한 신분제도인 카스트제와 브라만교를 성립시켰다.',
            coreData: [
                {
                    title: "인더스 문명의 발달",
                    content: "기원전 2500년경 인더스강 주변에서 하라파, 모헨조다로 등 발달된 도시 문명이 일어났다. 주택, 하수 시설, 목욕장 등을 갖춘 철저한 계획 도시였다. 청동기와 그림 문자를 사용하고 메소포타미아 지방과도 교역하였다."
                },
                {
                    title: "아리아인의 이동과 철기 사용",
                    content: "기원전 1500년경 중앙아시아의 유목 민족인 아리아인이 인더스강 유역으로 이동했고, 점차 동쪽으로 나아가 기원전 1000년경 갠지스강 유역까지 진출하였다. 이 무렵 아리아인은 철제 농기구로 농사를 짓고 철제 무기로 정복 활동을 벌였다."
                },
                {
                    title: "신분제도와 브라만교의 성립",
                    content: "아리아인은 원주민을 지배하기 위해 카스트제(바르나)라는 신분제를 만들었다. 자연 현상을 다스리는 신들을 찬양하는 경전 「베다」를 완성하며 브라만교가 성립되었고, 지배 계급인 브라만은 종교적 권위를 내세워 특권을 누렸다.",
                    image: "카스트제도.jpg"
                }
            ],
            wiki: '\'죽은 자의 언덕\'이라는 뜻의 모헨조다로는 기원전 2500년경 건설된 고도의 계획 도시다. 격자무늬의 뻗은 도로망, 덮개가 씌워진 완벽한 하수도 시설, 그리고 정교한 공중 목욕탕은 인도 문명이 얼마나 위생적이고 체계적인 사회였는지를 보여준다.',
            textbookData: {
                sources: [
                    {
                        title: "사료 탐구: 인도 문명과 아리아인의 이동",
                        image: "인도 문명과 아리아인의 이동.jpg",
                        content: "기원전 1500년경부터 철기를 지닌 아리아인들이 힌두쿠시 산맥을 넘어 인도 북서부로 남하하였다. 이들은 갠지스강 유역까지 진출하여 농경을 발달시키고, 선주민 지배를 정당화하기 위해 카스트제와 브라만교를 성립시켰다."
                    },
                    {
                        title: "사료 탐구: 모헨조다로에서 출토된 인장",
                        image: "모헨조다로에서 출토된 인장.jpg",
                        content: "인장에는 아직 완전히 해독되지 않은 그림 문자와 코뿔소, 물소 등 다양한 동물의 모습이 새겨져 있다. 인더스 문명의 사람들은 이를 통해 교역을 하거나 소유물을 표시했던 것으로 추정된다."
                    }
                ]
            }
        },
        {
            id: 'china', name: '중국 문명', detailTitle: '갑골 문자', engName: 'Yellow River',
            coords: '36.123, 114.335', period: '1600 BC',
            summary: '상나라의 신권 정치 특징이다. 이어 주나라가 봉건제와 천명·덕치 사상을 확립했다.',
            description: '기원전 2500년경 초기 국가가 등장하였다. 상나라는 강력한 신권 정치를 펼쳤고, 뒤이은 주나라는 넓은 영토를 통치하고자 봉건제를 실시하였다.',
            coreData: [
                {
                    title: "초기 국가와 상나라의 발전",
                    content: "기원전 8000년~6000년경 황허강과 창장강 유역에서 신석기 문화가 시작되었다. 기원전 2500년경부터 기름진 황토 지대인 황허강 유역에 성을 쌓고 정치 조직을 갖춘 초기 국가가 생겨났다. 기원전 1600년경 세워진 상나라는 청동 무기와 제기, 석기와 나무 농기구를 제작하고 달력을 만들었다."
                },
                {
                    title: "신권 정치와 갑골문",
                    content: "정치적, 종교적 권력을 지닌 상의 왕은 전쟁이나 제사 등 나라의 중요한 일을 결정할 때 점을 치는 신권 정치를 펼쳤다. 점을 친 내용과 결과를 거북 배딱지나 동물의 뼈에 새겼는데 이를 '갑골문'이라 하며, 한자의 기원이 되었다."
                },
                {
                    title: "주나라의 성립과 봉건제",
                    content: "기원전 11세기 무렵 상을 무너뜨린 주는 넓어진 영토를 효율적으로 다스리고자 수도 부근은 왕이 직접 다스리고, 나머지 지역은 왕족이나 공신(제후)이 다스리게 하는 '봉건제'를 실시하였다. 제후는 주 왕실을 받들면서 세금과 군사를 제공하였다."
                },
                {
                    title: "주나라의 쇠퇴",
                    content: "시간이 지나면서 주 왕실과 제후 간의 혈연관계는 느슨해졌고, 권위가 약해진 제후들은 점차 독자적인 세력으로 성장하였다. 기원전 8세기경 서북쪽의 유목 민족이 침입해 오자 주는 수도를 호경에서 낙읍(뤄양)으로 옮겼고, 이후 제후들이 서로 다투며 사회는 혼란에 빠졌다."
                }
            ],
            wiki: '정치적, 종교적 권력을 지닌 상나라의 왕은 전쟁이나 제사 등 나라의 중요한 일을 결정할 때 점을 쳤다. 점을 친 내용과 결과는 거북의 배딱지나 동물의 뼈에 새겼는데 이를 갑골문이라고 한다. 이 문자는 오늘날 한자의 기원이 되었다.',
            textbookData: {
                sources: [
                    {
                        title: "사료 탐구: 상과 주의 영역",
                        image: "상과 주의 영역.jpg",
                        content: "황허강 유역에서 일어난 상나라는 점차 영토를 넓혔고, 이후 주나라가 이를 멸망시키고 더 넓은 영토를 차지하였다. 주나라는 넓어진 영토를 효과적으로 다스리기 위해 새로운 통치 제도를 마련해야 했다."
                    },
                    {
                        title: "사료 탐구: 주의 봉건제",
                        image: "주의 봉건제.jpg",
                        content: "주나라는 수도와 그 주변은 왕이 직접 다스리고, 먼 지역은 왕의 일가친척이나 공신을 제후로 임명하여 다스리게 하는 봉건제를 실시하였다. 이는 핏줄에 바탕을 둔 혈연 중심의 통치 체제였다."
                    }
                ]
            }
        }
    ];

    const timelineEvents = [
        { year: '기원전 3500년경', title: '메소포타미아 문명 시작', desc: '티그리스·유프라테스강 유역에서 문명이 발생하고, 수메르인들이 도시 국가를 세웠다.', region: 'MESOPOTAMIA' },
        { year: '기원전 3000년경', title: '이집트 문명 시작', desc: '나일강 유역에서 통일 국가가 성립되었고, 국왕인 파라오가 피라미드를 건설하였다.', region: 'EGYPT' },
        { year: '기원전 2500년경', title: '인도 및 중국 문명 시작', desc: '인더스강 유역에 모헨조다로 등 계획 도시가 세워지고, 황허강 유역에서 문명이 시작되었다.', region: 'INDIA / CHINA' },
        { year: '기원전 1500년경', title: '아리아인의 이동', desc: '아리아인들이 인도 북서부로 남하하여 카스트제와 브라만교의 기틀을 마련하였다.', region: 'INDIA' },
        { year: '기원전 1046년', title: '주나라의 봉건제 실시', desc: '주나라가 상나라를 멸망시키고, 혈연관계에 바탕을 둔 봉건제를 실시하였다.', region: 'CHINA' }
    ];

    function renderCivilization(id) {
        currentCivId = id;
        currentSyncCivId = id;
        const civ = civilizations.find(c => c.id === id);
        if (!civ) return;
        playUIBeep();
        
        setSafeText('active-region-name', civ.engName.toUpperCase());
        setSafeText('popup-title', civ.name);
        setSafeText('popup-desc', civ.description);
        
        const mapIframe = document.getElementById('google-map-iframe');
        const popup = document.getElementById('civilization-popup');
        const originMarkers = document.getElementById('origin-markers');

        if (id === 'origin') {
            if (mapIframe) mapIframe.src = `https://maps.google.com/maps?q=30,60&z=3&t=k&output=embed`;
            if (popup) popup.classList.add('hidden');
            if (originMarkers) originMarkers.classList.remove('hidden');
        } else {
            if (mapIframe) mapIframe.src = `https://maps.google.com/maps?q=${civ.coords.replace(/\s/g,'')}&z=5&t=k&output=embed`;
            if (popup) popup.classList.remove('hidden');
            if (originMarkers) originMarkers.classList.add('hidden');
        }

        setSafeText('detail-title', civ.detailTitle);
        const detailImg = document.getElementById('detail-image');
        if (detailImg) detailImg.style.backgroundImage = `url('${civImages[id]}')`;
        setSafeHTML('detail-sections', `
            <p class='text-[13px] opacity-80 leading-relaxed font-kr break-keep'>${civ.wiki}</p>
        `);
        document.getElementById('btn-run-sync').onclick = () => {
            renderDetailedSync(id);
            switchMainTab('sync');
        };
        renderList();
    }

    function renderList() {
        const c = document.getElementById('civilization-list-container');
        if (!c) return;
        c.innerHTML = civilizations.map(cv => `
            <div onclick="renderCivilization('${cv.id}')" class="p-4 bg-white/5 border border-white/10 cursor-pointer shard transition-all hover:bg-white/10 ${cv.id === currentCivId ? 'border-animus-ai shadow-[0_0_10px_rgb(var(--theme-rgb)/0.3)]' : ''}">
                <div class="flex items-center gap-3">
                    <div>
                        <div class="text-white font-bold text-sm font-kr ${cv.id === 'origin' ? 'text-animus-ai drop-shadow-[0_0_5px_rgb(var(--theme-rgb)/0.8)]' : ''}">${cv.name}</div>
                        <div class="text-[10px] text-animus-text-dim font-mono mt-0.5">${cv.period}</div>
                    </div>
                </div>
                <p class="text-[11px] text-animus-text-dim mt-2 leading-relaxed">${cv.summary.substring(0, 50)}...</p>
            </div>
        `).join('');
    }

    function renderDetailedSync(id) {
        currentSyncCivId = id;
        const civ = civilizations.find(c => c.id === id);
        const tabs = document.getElementById('sync-tabs-container');
        const content = document.getElementById('sync-dynamic-content');
        
        if (tabs) tabs.innerHTML = civilizations.map(c => `
            <button onclick="playUIBeep(); renderDetailedSync('${c.id}')" class="px-6 py-3 font-kr text-sm font-bold border-b-4 cursor-pointer transition-all ${c.id === id ? 'text-animus-ai border-animus-ai bg-animus-ai/10' : 'text-animus-text-dim border-transparent hover:text-white'}">
                ${c.name}
            </button>
        `).join('');
        
        let sourcesHTML = civ.textbookData?.sources?.map(src => `
            <div class="source-box font-kr border border-white/10 mb-6 bg-black/20">
                <h4 class="text-animus-ai text-sm font-bold uppercase tracking-widest mb-4 flex items-center gap-3">
                    <span class="material-symbols-outlined text-xl">explore</span> ${src.title}
                </h4>
                ${src.customBlock ? src.customBlock : ''}
                ${src.image ? `<div class="relative w-full flex justify-center border border-white/30 bg-black/40 overflow-hidden shard mb-5 group">
                    <img src="${src.image}" class="max-w-full max-h-[300px] w-auto h-auto object-contain transition-transform duration-700 opacity-80 mix-blend-luminosity group-hover:mix-blend-normal group-hover:scale-105" onerror="this.style.display='none'">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/50 via-transparent to-transparent pointer-events-none"></div>
                </div>` : ''}
                <p class="text-[16px] text-animus-text-light leading-relaxed break-keep opacity-90">${src.content}</p>
            </div>
        `).join('') || '';

        // 교과서 코어 데이터 아카이브 HTML 매핑
        let coreDataHTML = civ.coreData?.map(data => `
            <div class="mb-6 p-6 bg-white/5 border border-white/10 shard shadow-panel-glow relative overflow-hidden group">
                <div class="absolute top-0 left-0 w-1 h-full bg-animus-ai/50 group-hover:bg-animus-ai transition-colors"></div>
                <h4 class="text-lg font-kr font-bold text-white mb-3 flex items-center gap-2">
                    <span class="material-symbols-outlined text-animus-ai text-xl">dataset</span>
                    ${data.title}
                </h4>
                <p class="text-[16px] font-kr leading-relaxed text-animus-text-light break-keep pl-2 border-l border-white/10">
                    ${data.content}
                </p>
                ${data.image ? `<div class="relative w-full flex justify-center border border-white/30 bg-black/40 overflow-hidden shard mt-5 group">
                    <img src="${data.image}" class="max-w-full max-h-[350px] w-auto h-auto object-contain transition-transform duration-700 opacity-80 mix-blend-luminosity group-hover:mix-blend-normal group-hover:scale-105" onerror="this.style.display='none'">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/50 via-transparent to-transparent pointer-events-none"></div>
                </div>` : ''}
            </div>
        `).join('') || '';

        if (content) content.innerHTML = `
            <div class="lg:col-span-2 space-y-2 lg:pr-8 lg:border-r border-white/10">
                <h3 class="text-xl font-bold text-animus-ai font-tech uppercase tracking-widest mb-4 border-b border-animus-ai/30 pb-2 inline-block">
                    <span class="material-symbols-outlined align-middle mr-2">import_contacts</span> 핵심 데이터 아카이브
                </h3>
                ${coreDataHTML}
            </div>
            <aside class="space-y-6">
                ${sourcesHTML}
            </aside>
        `;
    }

    function renderTimeline() {
        const c = document.getElementById('timeline-events-container');
        if (!c) return;
        c.innerHTML = timelineEvents.map((ev, i) => {
            const isTop = i % 2 === 0;
            return `
                <div class="relative flex-shrink-0" style="width: 550px; height: 100%;">
                    <div class="glass-panel p-5 shard border-white/10 hover:border-animus-ai transition-all duration-500 hover:scale-[1.02] group shadow-shard-shadow absolute w-full flex items-center gap-5 z-20" style="${isTop ? 'bottom: calc(50% + 30px);' : 'top: calc(50% + 30px);'} left: 0;">
                        <div class="flex-shrink-0 w-32 text-center">
                            <div class="text-animus-ai font-mono text-xl font-bold group-hover:text-glow break-keep leading-tight">${ev.year}</div>
                            <span class="px-2 py-1 bg-white/5 border border-white/10 text-[10px] text-animus-text-dim font-tech uppercase tracking-widest mt-2 inline-block">${ev.region}</span>
                        </div>
                        <div class="flex-1 border-l border-white/10 pl-5">
                            <h4 class="text-white font-bold text-lg font-kr mb-2">${ev.title}</h4>
                            <p class="text-[13px] text-animus-text-light font-kr leading-relaxed break-keep opacity-80 group-hover:opacity-100">${ev.desc}</p>
                        </div>
                    </div>
                    <div class="timeline-node transition-transform hover:scale-150 cursor-pointer absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-30" onclick="playUIBeep()"></div>
                    <div class="absolute left-1/2 -translate-x-1/2 w-0.5 bg-animus-ai/50 z-10" style="${isTop ? 'bottom: 50%; height: 30px;' : 'top: 50%; height: 30px;'}"></div>
                </div>
            `;
        }).join('');
    }

    function switchMainTab(tab) {
        playTransition(() => {
            const views = { database: 'view-database', sync: 'view-sync', timeline: 'view-timeline' };
            Object.entries(views).forEach(([key, id]) => {
                const el = document.getElementById(id);
                if (!el) return;
                if (key === tab) {
                    el.style.display = 'flex';
                    el.classList.remove('hidden');
                } else {
                    el.style.display = 'none';
                    el.classList.add('hidden');
                }
            });
            ['nav-database', 'nav-sync', 'nav-timeline'].forEach(n => {
                const el = document.getElementById(n);
                if (el) el.classList.remove('text-animus-ai', 'border-animus-ai');
            });
            const activeNav = document.getElementById('nav-' + tab);
            if (activeNav) activeNav.classList.add('text-animus-ai', 'border-animus-ai');
            if (tab === 'sync') renderDetailedSync(currentSyncCivId);
            if (tab === 'timeline') renderTimeline();
        });
    }

    window.onload = () => { renderCivilization('mesopotamia'); };
    let sec = 0;
    setInterval(() => {
        sec++;
        const h = String(Math.floor(sec / 3600)).padStart(2, '0'),
              m = String(Math.floor((sec % 3600) / 60)).padStart(2, '0'),
              s = String(sec % 60).padStart(2, '0');
        const t = document.getElementById('timer');
        if (t) t.innerText = `${h}:${m}:${s}`;
    }, 1000);
</script>
</body>
</html>
